# DinaHelper 数据获取与处理工作流程

## 系统架构概览

```
┌─────────────────────────────────────────────────────────────────┐
│                        数据采集层                                │
├─────────────────┬─────────────────┬─────────────────────────────┤
│ batch_downloader│ 油猴脚本        │ parse_recommendation        │
│ (成绩CSV)        │ (学号+课表HTML) │ (推免PDF/MD)                 │
└────────┬────────┴────────┬────────┴──────────────┬──────────────┘
         │                 │                        │
         ▼                 ▼                        ▼
┌─────────────────┬─────────────────┬─────────────────────────────┐
│ grade_manager   │ import_teacher  │ import_recommendation       │
│ (学生+成绩+排名) │ (教师信息)       │ (推免数据)                   │
└────────┬────────┴────────┬────────┴──────────────┬──────────────┘
         │                 │                        │
         ▼                 ▼                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                     PostgreSQL 数据库                            │
│  student | course_score | course_name | recommendation          │
└────────────────────────────────┬────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                    DinaHelper Server (FastAPI)                   │
│        /kldj/cs/* | /kldj/stu/* | /kldj/rec/* | /kldj/verify/*  │
└────────────────────────────────┬────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                    ScoreQuery (微信小程序)                       │
│       成绩查询 | 排名查询 | GPA计算 | 挂科率 | 推免信息            │
└─────────────────────────────────────────────────────────────────┘
```

---

## 一、脚本功能一览

| 脚本 | 功能 | 输入 | 输出 |
|------|------|------|------|
| `batch_downloader.py` | 批量下载成绩CSV | `ids.txt` | `all_grades.zip` |
| `single_download.py` | 单个学号下载成绩 | 学号 | `学号.csv` |
| `grade_manager.py` | 成绩入库+排名计算 | ZIP/目录 | DB: student, course_score |
| `parse_schedule.py` | 解析课表HTML提取教师 | ZIP/目录/文件 | 统计输出 |
| `import_teacher.py` | 教师信息写入DB | 课表ZIP | DB: course_score.c_teacher |
| `parse_recommendation.py` | 解析推免PDF/MD | PDF/MD文件 | `recommendation_parsed.txt` |
| `import_recommendation.py` | 推免数据入库 | 解析结果 | DB: recommendation |
| `CDUT教务工具箱.user.js` | 油猴脚本：获取学号+采集课表 | 教务系统 | TXT/ZIP |

---

## 二、数据采集流程

### 2.1 获取学号列表

**方式A：油猴脚本（推荐）**
1. 安装 `CDUT教务工具箱.user.js` 到 Tampermonkey
2. 登录教务系统 → 访问 `https://jw.cdut.edu.cn/jsxsd/xskb/xsqtkb.do`
3. 点击「批量获取学号」→ 输入年级前缀（如 `2022`）
4. 下载生成的 `学号列表_xxx.txt` → 重命名为 `ids.txt`

**方式B：手动准备**
- 每行一个学号，格式：12位纯数字

### 2.2 批量下载成绩

```bash
python batch_downloader.py -i ids.txt -w 150 --proxy -z all_grades.zip
```

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `-i` | 学号文件路径 | `ids.txt` |
| `-w` | 并发数 | 150 |
| `-p` | 启用代理 | 按config |
| `-z` | 输出ZIP文件名 | `all_grades.zip` |

**流程**：
1. 读取学号列表，跳过已下载的
2. 异步并发请求教务系统报表接口
3. 下载Excel → 转换CSV → 保存到 `results_csv/`
4. 失败学号自动重试
5. 最终打包为ZIP

### 2.3 单个学号测试

```bash
python single_download.py 202212345678
```

### 2.4 采集课表（油猴脚本）

1. 点击「批量采集课表」
2. 输入学号前缀 + 并发数
3. 自动根据入学年份计算学期范围
4. 下载 `课表_xxxx_日期.zip`（按学号/学期组织的HTML）

---

## 三、数据入库流程

### 3.1 导入成绩到数据库

```bash
python grade_manager.py --zip all_grades.zip
```

**执行步骤**：
1. 多线程解析ZIP内CSV（80并发）
2. 解析学生信息（学号、姓名、学院、专业、班级、均分、GPA）
3. 解析课程成绩（学期、课程名、类型、学分、成绩、补考/重修/刷分标记）
4. 批量 Upsert 到 `student` 表（5000条/批）
5. 批量 Upsert 到 `course_score` 表（10000条/批）
6. 同步课程名到 `course_name` 表
7. **执行SQL窗口函数计算排名**

### 3.2 导入教师信息

```bash
python import_teacher.py --zip 课表_2022_xxx.zip [--dry-run]
```

**执行步骤**：
1. 多进程解析课表HTML（CPU密集型）
2. 提取每门课的教师（支持理论/实践分开）
3. 转换学期格式：`2024-2025学年第一学期` → `202401`
4. 批量 UPDATE `course_score.c_teacher` 字段

**教师格式**：
- 单教师：`张s`（姓+名拼音首字母）
- 多教师：`张s,李m`
- 理论实践不同：`理论:张s 实践:李m`

### 3.3 导入推免数据

```bash
# 1. 解析PDF/MD生成txt
python parse_recommendation.py

# 2. 导入数据库
python import_recommendation.py
```

**数据来源**：
- `推免数据/2024名单.md` - Markdown表格
- `推免数据/2025名单.pdf` - PDF公示文件
- `推免数据/2026名单.pdf` - PDF公示文件

**提取字段**：学号、姓名、性别、政治面貌、学院、专业、GPA、均分、表现分、综合分、排名、人数、备注

---

## 四、数据库表结构

### 4.1 student 表

| 字段 | 类型 | 说明 |
|------|------|------|
| `s_id` | VARCHAR(14) PK | 学号 |
| `s_name` | VARCHAR(50) | 姓名 |
| `s_py` | VARCHAR(255) | 姓名拼音首字母 |
| `s_college` | VARCHAR(50) | 学院 |
| `s_major` | VARCHAR(50) | 专业 |
| `s_grade` | VARCHAR(10) | 年级 |
| `s_class` | VARCHAR(20) | 班级号（10位） |
| `s_avg` | FLOAT | 平均分 |
| `s_gpa` | FLOAT | 绩点 |
| `class_avg_rank` | INT | 班级均分排名 |
| `class_gpa_rank` | INT | 班级绩点排名 |
| `major_avg_rank` | INT | 专业均分排名 |
| `major_gpa_rank` | INT | 专业绩点排名 |

### 4.2 course_score 表

| 字段 | 类型 | 说明 |
|------|------|------|
| `s_id` | VARCHAR(14) PK | 学号 |
| `c_term` | VARCHAR(8) PK | 学期（如202401） |
| `c_name` | VARCHAR(100) PK | 课程名 |
| `c_score` | FLOAT | 成绩 |
| `c_type` | VARCHAR(20) | 类型（必修/选修等） |
| `c_hours` | VARCHAR(10) | 学时 |
| `c_credit` | FLOAT | 学分 |
| `c_pass` | SMALLINT | 0正常 1补考 2重修 3刷分 |
| `c_teacher` | VARCHAR(200) | 教师拼音缩写 |

### 4.3 recommendation 表

| 字段 | 类型 | 说明 |
|------|------|------|
| `s_id` | VARCHAR(14) PK | 学号 |
| `year` | INT PK | 推免年份 |
| `name` | VARCHAR(20) | 姓名 |
| `gender` | VARCHAR(2) | 性别 |
| `political` | VARCHAR(20) | 政治面貌 |
| `college` | VARCHAR(60) | 学院 |
| `major` | VARCHAR(60) | 专业 |
| `course_gpa` | FLOAT | 课程绩点 |
| `course_avg` | FLOAT | 课程均分 |
| `perf_score` | FLOAT | 表现分 |
| `comp_score` | FLOAT | 综合分 |
| `comp_rank` | INT | 综合排名 |
| `major_total` | INT | 专业人数 |
| `remark` | VARCHAR(100) | 备注 |

### 4.4 排名计算SQL

```sql
UPDATE student SET
    class_avg_rank = t.c_avg_r,
    class_gpa_rank = t.c_gpa_r,
    major_avg_rank = t.m_avg_r,
    major_gpa_rank = t.m_gpa_r
FROM (
    SELECT s_id,
        RANK() OVER (PARTITION BY s_class ORDER BY s_avg DESC) as c_avg_r,
        RANK() OVER (PARTITION BY s_class ORDER BY s_gpa DESC) as c_gpa_r,
        RANK() OVER (PARTITION BY LEFT(s_class, 8) ORDER BY s_avg DESC) as m_avg_r,
        RANK() OVER (PARTITION BY LEFT(s_class, 8) ORDER BY s_gpa DESC) as m_gpa_r
    FROM student
) t
WHERE student.s_id = t.s_id
```

**说明**：`LEFT(s_class, 8)` 提取专业代码（班级号前8位）

---

## 五、后端 API 服务

### 5.1 启动服务

```bash
cd d:\Code\Python\DinaHelperServer
uvicorn app.main:app --host 0.0.0.0 --port 3099
```

### 5.2 核心接口

| 接口 | 方法 | 功能 | 需验证 |
|------|------|------|--------|
| `/kldj/auth/wxlogin` | POST | 微信登录获取token | ❌ |
| `/kldj/verify/challenge` | GET | 获取验证题目 | ✅ |
| `/kldj/verify/unban` | POST | 看广告解封 | ✅ |
| `/kldj/cs/query/id` | POST | 查询成绩 | ✅ |
| `/kldj/cs/fail-rate` | POST | 挂科率统计 | ✅ |
| `/kldj/cs/course-rank` | GET | 单科排名 | ✅ |
| `/kldj/stu/rank/id` | POST | 查询排名 | ✅ |
| `/kldj/stu/rank/major` | GET | 专业排名列表 | ✅ |
| `/kldj/stu/rank/class` | GET | 班级排名列表 | ✅ |
| `/kldj/stu/query/py` | GET | 按拼音搜学生 | ✅ |
| `/kldj/stu/query/name` | GET | 按姓名搜学生 | ✅ |
| `/kldj/rec/list` | GET | 推免信息列表 | ✅ |
| `/kldj/notice/{key}` | GET | 获取公告 | ❌ |

### 5.3 验证机制

```
用户请求查询
     │
     ▼
┌────────────────┐     是     ┌────────────────┐
│ 有有效session? │───────────▶│ 直接返回数据    │
└───────┬────────┘            └────────────────┘
        │ 否
        ▼
┌────────────────┐
│ /verify/challenge │
│ 随机抽1门课程    │
└───────┬────────┘
        │
        ▼
┌────────────────┐     错     ┌────────────────┐
│ 用户回答成绩    │───────────▶│ 剩余机会-1      │
└───────┬────────┘            │ 3次后封禁10分钟 │
        │ 对                  └────────────────┘
        ▼
┌────────────────┐
│ 返回sessionToken│
│ (24小时有效)    │
└────────────────┘
```

---

## 六、前端小程序

### 6.1 用户查询流程

```
输入学号/姓名/拼音 → 身份验证（回答成绩） → 查看结果
     │                    │                    │
     ▼                    ▼                    ▼
  姓名/拼音         验证失败3次封禁         成绩/排名/GPA
  → 选择学号        → 看广告解封           → 详细列表
```

### 6.2 功能模块

| 模块 | 功能 | 对应接口 |
|------|------|----------|
| 成绩查询 | 查看所有课程成绩 | `/cs/query/id` |
| 排名查询 | 班级/专业排名+排名列表 | `/stu/rank/*` |
| GPA计算 | 模拟计算绩点 | `/cs/query/id` |
| 挂科率 | 课程难度参考 | `/cs/fail-rate` |
| 推免信息 | 历年推免数据 | `/rec/list` |

---

## 七、完整数据更新流程

### 7.1 更新成绩数据

```bash
cd d:\Code\Python\Test\成绩爬虫

# 1. 获取学号（油猴脚本导出ids.txt）

# 2. 批量下载成绩
python batch_downloader.py -i ids.txt -w 150 --proxy

# 3. 导入数据库（含排名计算）
python grade_manager.py --zip all_grades.zip
```

### 7.2 更新教师信息

```bash
# 1. 油猴脚本采集课表ZIP

# 2. 导入教师
python import_teacher.py --zip 课表_2022_xxx.zip
```

### 7.3 更新推免数据

```bash
# 1. 放置PDF/MD到 推免数据/ 目录

# 2. 解析并导入
python parse_recommendation.py
python import_recommendation.py
```

---

## 八、配置文件

### 爬虫配置 (`config.py`)

```python
BASE_URL = 'http://rpsjw.cdut.edu.cn/qzbb'  # 教务报表系统
HEADERS = {'User-Agent': 'curl/7.29.0'}
PROXY = 'socks5://127.0.0.1:10801'
USE_PROXY = True

DB_URI = 'postgresql+psycopg2://user:pass@host:5432/cdut-score'
DB_POOL_SIZE = 32
DB_MAX_OVERFLOW = 64
DB_POOL_RECYCLE = 3600
```

### 后端配置 (`.env`)

```env
DB_HOST=localhost
DB_PORT=5432
DB_NAME=cdut-score
DB_USER=xxx
DB_PASSWORD=xxx
REDIS_HOST=localhost
REDIS_PORT=6379
WX_APP_ID=xxx
WX_APP_SECRET=xxx
```

---

## 九、注意事项

1. **网络环境**：爬虫需校园网或通过代理访问教务系统（`rpsjw.cdut.edu.cn`）
2. **并发控制**：`batch_downloader` 建议 `workers <= 150`，过高触发封禁
3. **数据冲突**：所有导入脚本使用 Upsert（ON CONFLICT DO UPDATE），可重复执行
4. **字符编码**：CSV 支持 UTF-8 和 GBK 自动识别
5. **排名更新**：`grade_manager` 每次导入后自动重新计算全部排名
6. **学期格式**：数据库用 `YYYYSS`（如 `202401`=2024-2025第一学期）
7. **教师拼音**：`import_teacher` 将教师姓名转为「姓+名首字母」格式便于搜索
8. **推免数据**：PDF解析可能有误，导入后需人工抽查验证
9. **数据清理原则「只新不旧，只分不合」**：
   - 各表忠于各自原始数据源（student←成绩CSV，recommendation←推免文件）
   - 标点统一半角，但专业/学院名称保留原始文件写法
   - 不强行合并历史上分开的专业方向
